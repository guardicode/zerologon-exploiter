from logging import getLogger
from pprint import pformat
from typing import Any, Dict

from common.event_queue import IAgentEventPublisher
from common.types import AgentID, Event
from common.utils.code_utils import del_key
from infection_monkey.i_puppet import ExploiterResultData, TargetHost

from .zerologon_options import ZerologonOptions

logger = getLogger(__name__)


class StubZerologonExploiter:
    def __init__(self, *args, **kwargs):
        pass

    def exploit_host(self, *args, **kwargs):
        return ExploiterResultData()


class Plugin:
    def __init__(
        self,
        *,
        plugin_name: str,
        agent_id: AgentID,
        agent_event_publisher: IAgentEventPublisher,
        **kwargs,
    ):
        self._exploiter = StubZerologonExploiter(
            plugin_name,
            agent_id,
            agent_event_publisher,
            {"zerologon-exploiter"},
        )

    def run(
        self,
        *,
        host: TargetHost,
        options: Dict[str, Any],
        interrupt: Event,
        **kwargs,
    ) -> ExploiterResultData:
        # HTTP ports options are hack because they are needed in fingerprinters
        del_key(options, "http_ports")

        try:
            logger.debug(f"Parsing options: {pformat(options)}")
            zerologon_options = ZerologonOptions(**options)
        except Exception as err:
            msg = f"Failed to parse Zerologon options: {err}"
            logger.exception(msg)
            return ExploiterResultData(error_message=msg)

        try:
            logger.debug(f"Running Zerologon exploiter on host {host.ip}")
            return self._exploiter.exploit_host(host, zerologon_options, interrupt)
        except Exception as err:
            msg = f"An unexpected exception occurred while attempting to exploit host: {err}"
            logger.exception(msg)
            return ExploiterResultData(error_message=msg)
